
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	СтруктураПараметров = ПолучитьИзВременногоХранилища(Параметры.Адрес);

	Если СтруктураПараметров.Ссылка <> "" Тогда 
		ЗаполнитьТабТовары(СтруктураПараметров.Ссылка);
	Иначе
		Сообщить("Не удалось создать документ отгрузки");	
	КонецЕсли;
	

КонецПроцедуры


&НаСервере
Процедура ЗаполнитьТабТовары(Док)
	
	ТабТовары.Очистить();
	
	СКСписание = НайтиДокСписания(Док);
	
	Если СКСписание.Пустая() = Истина Тогда
		НовыйДок = Документы.СК_СписаниеСклад.СоздатьДокумент();  
		НовыйДок.Дата = ТекущаяДата();
		НовыйДок.ДокументОснования = Док;
		НовыйДок.СтатусСборки = Перечисления.СК_СтатусСборкиРеализации.НеСобран;
	Иначе
		НовыйДок = СКСписание.ПолучитьОбъект();
	КонецЕсли;
	
	ВТЧ = Док.Товары.Выгрузить();
	НовыйДок.Товары.Загрузить(ВТЧ); 
	
	Попытка
		НовыйДок.Записать(РежимЗаписиДокумента.Проведение); 
		Д = НовыйДок;
		ЭтаФорма.ДокОсн = Д.Ссылка;
	Исключение
		Сообщить("Не удалось создать документ отгрузки");	
	КонецПопытки;
	
	ОбновитьТабТовары();
	
КонецПроцедуры


&НаСервере
Функция НайтиДокСписания(Док)	
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	               |	СК_СписаниеСклад.Ссылка КАК Ссылка
	               |ИЗ
	               |	Документ.СК_СписаниеСклад КАК СК_СписаниеСклад
	               |ГДЕ
	               |	СК_СписаниеСклад.ПометкаУдаления = &ПометкаУдаления
	               |	И СК_СписаниеСклад.Проведен = &Проведен
	               |	И СК_СписаниеСклад.ДокументОснования = &ДокументОснования";
	
	Запрос.УстановитьПараметр("ПометкаУдаления",Ложь);
	Запрос.УстановитьПараметр("Проведен",Истина);
	Запрос.УстановитьПараметр("ДокументОснования",Док);
	
	Рез = Запрос.Выполнить().Выбрать();
	
	Если Рез.Следующий() Тогда
		Возврат Рез.Ссылка;
	Иначе
		Возврат Документы.СК_СписаниеСклад.ПустаяСсылка();
	КонецЕсли;
	
КонецФункции

&НаСервере
Процедура ОбновитьТабТовары()
	
	ТабТовары.Очистить();
	
	ВТЧТовары = ЭтаФорма.ДокОсн.Товары.Выгрузить();
	ВТЧСобрано = ЭтаФорма.ДокОсн.СобранныеТовары.Выгрузить();
	ВТЧСобрано.Свернуть("Номенклатура","Количество");
	ТабТовары.Загрузить(ВТЧТовары);
	
	Для Каждого стр из ТабТовары Цикл
		Отбор = Новый Структура;
		Отбор.Вставить("Номенклатура",стр.Номенклатура);
		Строки = ВТЧСобрано.НайтиСтроки(Отбор);
		Если Строки.Количество() = 1 Тогда
			стр.КоличествоСобрано = Строки[0].Количество; 
		КонецЕсли;
	КонецЦикла; 
	//
	Отбор = Новый Структура;
	Отбор.Вставить("Собран",Ложь);
	
	ПСтроки = ТабТовары.НайтиСтроки(Отбор);
	Если ПСтроки.Количество() = 0 Тогда  
		Док = ДокОсн.ПолучитьОбъект();
		Если Док.СтатусСборки = Перечисления.СК_СтатусСборкиРеализации.НеСобран Тогда 
			ДокУчет = Док.ДокументОснования.ПолучитьОбъект();
			ДокУчет.СтатусСборки = Перечисления.СК_СтатусСборкиРеализации.Собран;
			Док.СтатусСборки = Перечисления.СК_СтатусСборкиРеализации.Собран;
			Док.Записать(РежимЗаписиДокумента.Проведение); 
			ДокУчет.Записать(РежимЗаписиДокумента.Проведение); 
		КонецЕсли;
		Если Док.СтатусСборки = Перечисления.СК_СтатусСборкиРеализации.Собран Тогда 
	    	ЭтаФорма.Элементы.ГруппаТоваров.Доступность = Ложь;
		КонецЕсли;
		
		ЭтаФорма.Элементы.Собран.Заголовок = "Документ собран";
	КонецЕсли;
	ТабТовары.Сортировать("Собран ВОЗР");
КонецПроцедуры

&НаКлиенте
Процедура ТабТоварыВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	
	ПараметрыФормыОстатки = Новый Структура;     
	ПараметрыФормыОстатки.Вставить("Ссылка",ДокОсн);
	ПараметрыФормыОстатки.Вставить("Номенклатура",Элемент.ТекущиеДанные.Номенклатура);
	АдресПередаваемыхПараметров = ПоместитьВоВременноеХранилище(ПараметрыФормыОстатки,Новый УникальныйИдентификатор);
	_Параметры = новый Структура("Адрес", АдресПередаваемыхПараметров);
	ОписаниеОповещения = Новый ОписаниеОповещения("ОбработатьЗакрытиеФормыНовыйЗаказ", ЭтаФорма);
	ОткрытьФорму("Обработка.СК_МобСклад.Форма.ФормаСборкиЗаказа", _Параметры,ЭтаФорма, , , , ОписаниеОповещения,РежимОткрытияОкнаФормы.БлокироватьВесьИнтерфейс);

КонецПроцедуры    

&НаКлиенте
Процедура ОбработатьЗакрытиеФормыНовыйЗаказ(Значение, ДопПараметры) Экспорт
ОбновитьТабТовары();	
КонецПроцедуры

